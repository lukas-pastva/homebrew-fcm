#!/bin/bash

check_docker() {
    if ! command -v docker &> /dev/null; then
        echo "Docker is not installed. Please install Docker and try again."
        exit 1
    fi
}

reinstall(){
    read -p "Enter GitLab Username: " GL_USERNAME
    export GL_USERNAME
    
    read -sp "Enter GitLab Token: " GL_PASSWORD
    export GL_PASSWORD

    echo ""
    echo "Starting fcm container..."
    docker stop fcm >/dev/null 2>&1 || true
    docker container rm fcm >/dev/null 2>&1 || true
    docker image rm registry.gitlab.com/fatchilli/devops/fcm/fcm:latest >/dev/null 2>&1 || true
    mkdir -p ~/fcm
    docker run --name fcm -d --restart=unless-stopped -e GL_USERNAME=${GL_USERNAME} -e GL_PASSWORD=${GL_PASSWORD} -v /var/run/docker.sock:/var/run/docker.sock -v ~/fcm:/root/fcm registry.gitlab.com/fatchilli/devops/fcm/fcm:latest >/dev/null 2>&1
}

ensure_running() {
    check_docker
    if ! docker ps --format '{{.Names}}' | grep -q '^fcm$'; then
        reinstall
    fi
}

# The main command handler
function main() {
    case "$1" in
        restart)
            echo "Reinstalling fcm container..."
            ensure_running
            ;;
        *)
            ensure_running
            docker exec -i fcm fcm "$@"
            ;;
    esac
}

# Check if at least one argument is provided
if [ $# -lt 1 ]; then
    ensure_running
    docker exec -i fcm fcm help
    exit 1
fi

# Run the main function with all script arguments
main "$@"
